<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/>
    <title>Simple Map</title>
    <link rel="stylesheet" href="http://js.arcgis.com/3.8/js/esri/css/esri.css">
    <style>
        html, body, #map {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            background-color: #FFF;
            overflow: hidden;
            font-family: "Trebuchet MS";
        }
        .dj_ie .infowindow .window .top .right .user .content { position: relative; }
        .dj_ie .simpleInfoWindow .content {position: relative;}

        .esriPopup .contentPane {
            color: white;
            background-color: black;
        }
        .dijitTextBox{ color: #000000;}
        .esriAttributeInspector {height:100px;}
        .esriAttributeInspector .atiLayerName {display:none;}
        .saveButton {
            padding-left:45px;
            margin:0px;width:16px; height:16px;
        }
        .basic-btn{
            background-color: #000000;
            border-color: #ffffff 1px;
            color: #ffffff;
            padding: 8px;
            position: relative; float: left;
        }
        #button-div1{
            position: relative;
            background: #000000;
            color: #ffffff;
            width: 100%;
            height: 50px;
        }
        #img-offline-indicator{
            padding: 8px;
            position: relative; float: right;
        }
    </style>
    <script src="../vendor/offline/offline.min.js"></script>
    <script>
        Offline.options = {
            checks: {
                image: {
                    url: function() {
                        return 'http://esri.github.io/offline-editor-js/tiny-image.png?_=' + (Math.floor(Math.random() * 1000000000));
                    }
                },
                active: 'image'
            }
        }

        var locationPath = location.pathname.replace(/\/[^/]+$/, "");
        var dojoConfig = {
            paths: {
                edit: locationPath  + "/../lib/edit",
                vendor: locationPath + "/../vendor"
            }
        }
    </script>
    <script src="http://js.arcgis.com/3.8/"></script>
    <script>
        var offlineFeaturesManager;
        var map,busStopsFeatureLayer,currentFeature;
        var imgOfflineIndicator,btnOnlineOffline;
        var redPinPath = "../samples/images/red-pin.png";
        var bluePinPath = "../samples/images/blue-pin.png"

        require([
            "esri/map",
            "esri/tasks/query",
            "esri/layers/FeatureLayer",
            "edit/offlineFeaturesManager",
            "esri/dijit/AttributeInspector",
            "dojo/dom-construct",
            "dijit/form/Button",
            "dojo/domReady!"],
            function(Map,Query,FeatureLayer,OfflineFeaturesManager,AttributeInspector,domConstruct,Button) {

                offlineFeaturesManager = new OfflineFeaturesManager();
                offlineFeaturesManager.on(offlineFeaturesManager.events.EDITS_ENQUEUED, updateStatus);
                offlineFeaturesManager.on(offlineFeaturesManager.events.EDITS_SENT, updateStatus);
                offlineFeaturesManager.on(offlineFeaturesManager.events.ALL_EDITS_SENT, updateStatus);

                imgOfflineIndicator = document.getElementById("img-offline-indicator");
                imgOfflineIndicator.offlineColor = "blue";

                Offline.check();
                Offline.on('up', goOnline );
                Offline.on('down', goOffline );

                map = new Map("map", {
                    basemap: "topo",
                    center: [-104.98,39.74], // long, lat
                    zoom: 10,
                    sliderStyle: "small"
                });

                busStopsFeatureLayer = new FeatureLayer("http://services.arcgis.com/IZtlGBUe4KTzLOl4/arcgis/rest/services/BPX_RTD_BusStops2/FeatureServer/0",{
                    mode: FeatureLayer.MODE_SNAPSHOT,
                    outFields: ["OBJECTID","BSID","ROUTES","STOPNAME"]
                })

                map.on("layers-add-result",initEditing);

                map.addLayers([busStopsFeatureLayer]);

                function initEditing(evt){

                    offlineFeaturesManager.extend(busStopsFeatureLayer);

                    map.infoWindow.on("hide", function() {
                        busStopsFeatureLayer.clearSelection();
                    });

                    btnOnlineOffline = document.getElementById("btn-online-offline");

                    var layerInfos = [{
                        'featureLayer': busStopsFeatureLayer,
                        'showAttachments': false,
                        'isEditable': true,
                        'showDeleteButton': false,
                        'fieldInfos': [
                            {'fieldName': 'OBJECTID', 'isEditable':false, 'label':'ID:'},
                            {'fieldName': 'BSID', 'isEditable':false, 'label':'Bus stop ID:'},
                            {'fieldName': 'ROUTES', 'isEditable':false,'label':'Routes:'},
                            {'fieldName': 'STOPNAME', 'isEditable':true, 'label':'Stop name:'}
                        ]
                    }];

                    var attInspector = new AttributeInspector({
                        layerInfos:layerInfos
                    }, "test");

                    //add a save button next to the delete button
                    var saveButton = new Button({ label: "Save", "class": "saveButton"});
                    domConstruct.place(saveButton.domNode, attInspector.deleteBtn.domNode, "after");

                    saveButton.on("click", function(){
                        busStopsFeatureLayer.applyEdits(null, [currentFeature], null);
                    });

                    attInspector.on("attribute-change", function(evt) {
                        //store the updates to apply when the save button is clicked
                        currentFeature.attributes[evt.fieldName] = evt.fieldValue;
                        console.log("CHANGE " + evt.fieldValue)
                    });

                    attInspector.on("next", function(evt) {
                        currentFeature = evt.feature;
                        console.log("Next " + currentFeature.attributes.objectid);
                    });

                    attInspector.on("delete", function(evt){
                        evt.feature.getLayer().applyEdits(null,null,[currentFeature]);
                        map.infoWindow.hide();
                    });


                    busStopsFeatureLayer.on("click", function(evt) {
                        currentFeature = evt.graphic

                        var query = new Query();
                        query.geometry =  evt.graphic.geometry;
                        busStopsFeatureLayer.selectFeatures(query,FeatureLayer.SELECTION_NEW,
                            function(evt){
                                console.log("Success: " + JSON.stringify(evt[0].attributes))
                            },function(err){
                                console.log("ERROR " + JSON.stringify(err));
                        });

                        map.infoWindow.setTitle(currentFeature.attributes.STOPNAME);
                        map.infoWindow.show(evt.screenPoint,map.getInfoWindowAnchor(evt.screenPoint));
                    }.bind(this));

                    map.infoWindow.setContent(attInspector.domNode);
                    map.infoWindow.resize(350, 240);

                }

                function updateStatus(){

                }

            }
        );

        function updateFeature(){
            var stops = document.getElementById("textArea1").innerHTML;
            currentFeature.attributes.STOPS = stops;
            console.log("STOPS " + stops)
            //busStopsFeatureLayer.applyEdits(null,[currentFeature],null);
        }

        function deleteFeature(){
            busStopsFeatureLayer.applyEdits(null,null,[currentFeature]);
        }

        function goOnlineOffline(){
            if(imgOfflineIndicator.offlineColor == "blue"){
                btnOnlineOffline.innerHTML = "Go Online";
                imgOfflineIndicator.src = redPinPath;
                imgOfflineIndicator.offlineColor = "red";
                goOffline()
            }
            else{
                btnOnlineOffline.innerHTML = "Go Offline";
                imgOfflineIndicator.src = bluePinPath;
                imgOfflineIndicator.offlineColor = "blue";
                goOnline();
            }
        }

        function goOnline(){
            offlineFeaturesManager.goOnline(function(success,error){
                if(success == true){
                    alert("Offline edits successfully synced");
                }
                else{
                    alert("There was a problem syncing offline edits: " + JSON.stringify(error));
                }
            });
        }

        function goOffline(){
            offlineFeaturesManager.goOffline();
        }
    </script>
</head>

<body>
<div id="button-div1">
    <button class="basic-btn" onclick="goOnlineOffline()" id="btn-online-offline">Go Offline</button>
    <img id="img-offline-indicator" onclick="goOnlineOffline()" src="../samples/images/blue-pin.png"/>
</div>
<div id="test"></div>
<div id="map"></div>
</body>
</html>