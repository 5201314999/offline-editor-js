<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Military Offline Editor</title>

	<link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" >
    <link rel="stylesheet" href="http://js.arcgis.com/3.8/js/dojo/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="http://js.arcgis.com/3.8/js/esri/css/esri.css" />

	<style>
		html,body{height:100%;width:100%;margin:0;overflow:hidden;}
		#map{
			padding:0;
		}
		#header{
			font-size: 1.1em;
			font-family: sans-serif;
			padding-left: 1em;
			padding-top:4px;
			color:#660000;
		}
		.claro .dijitContentPane {
			padding: 2px;
		}
		.templatePicker {
			border: none;
		}
		.templatePicker .itemLabel {
			font-size: 11px;
		}

		#connectivityIndicator {
            text-align: center;
            color: white;
            background-color: #0C0;
            padding: 4px;
		}

		.dj_ie .infowindow .window .top .right .user .content { position: relative; }
		.dj_ie .simpleInfoWindow .content {position: relative;}	
	</style>
	
	<script>
		var locationPath = location.pathname.replace(/\/[^/]+$/, "");
		var dojoConfig = {
			paths: { 
				edit: locationPath  + "/../lib/edit",
				vendor: locationPath + "/../vendor"
			}
		}
		window.proxyPath = "../../lib/proxy.php";
	</script>

	<script src="http://js.arcgis.com/3.8/"></script>
	<script>

	// based on https://developers.arcgis.com/javascript/jssamples/ed_simpletoolbar.html
	
	var map;

	require([
	    "esri/map", 
	    "esri/tasks/GeometryService",
	    "esri/toolbars/edit",

	    "esri/layers/ArcGISTiledMapServiceLayer",
	    "esri/layers/FeatureLayer",
	    "edit/offlineFeatureService",

	    "esri/symbols/SimpleMarkerSymbol",
	    "esri/symbols/SimpleLineSymbol",

	    "esri/dijit/editing/Editor",
	    "esri/dijit/editing/TemplatePicker",

	    "esri/config",
	    "dojo/i18n!esri/nls/jsapi",

	    "dojo/_base/array", "dojo/parser", "dojo/keys",

	    "dijit/layout/BorderContainer", "dijit/layout/ContentPane", 
	    "dojo/domReady!"
	], function(
	    Map, GeometryService, Edit, 
	    ArcGISTiledMapServiceLayer, FeatureLayer, offlineFeatureService,
	    SimpleMarkerSymbol, SimpleLineSymbol, 
	    Editor, TemplatePicker,
	    esriConfig, jsapiBundle,
	    arrayUtils, parser, keys
	) {
		parser.parse();

		esriConfig.defaults.io.proxyUrl = "../lib/proxy.php";

		map = new Map("map", {
			basemap: "satellite",
			center: [-0.958, 41.846],
			zoom: 13,
			slider: true
		});

		map.on('layers-add-result', initEditor);

		var fsUrl = "http://services2.arcgis.com/CQWCKwrSm5dkM28A/arcgis/rest/services/Military/FeatureServer/";
		// var layersIds = [0,1,2,3,4,5,6];
		var layersIds = [1,2,3];
		var layers = [];

		layersIds.forEach(function(layerId)
		{
			var layer = new FeatureLayer(fsUrl + layerId, {
				mode: FeatureLayer.MODE_SNAPSHOT,
				outFields: ['*']
			});
			layers.push(layer);			
		})

		map.addLayers(layers);

		//////////////////////////////////////

		function initEditor(evt)
		{
			try {

				/* extend layer with offline detection functionality */
				evt.layers.forEach(function(result)
				{
					var layer = result.layer;
					offlineFeatureService.extend(layer);
				});

				/* template picker */
				var templateLayers = evt.layers.map(function(result){return result.layer;});
				var templatePicker = new TemplatePicker({
					featureLayers: templateLayers,
					grouping: true,
					rows: "auto",
					columns: 3,
				}, "templateDiv");
				templatePicker.startup();

				/* editor */
				var layers = evt.layers.map(function(result){return {featureLayer: result.layer};});
				var settings = {
					map: map,
					templatePicker: templatePicker,
					layerInfos: layers,
					toolbarVisible: true,
					createOptions: {
						polylineDrawTools: [ 
							Editor.CREATE_TOOL_FREEHAND_POLYLINE,
							Editor.CREATE_TOOL_POLYLINE ],
						polygonDrawTools: [
							Editor.CREATE_TOOL_FREEHAND_POLYGON,
							Editor.CREATE_TOOL_POLYGON,
							Editor.CREATE_TOOL_RECTANGLE ]
					},
					toolbarOptions: {
						reshapeVisible: false
					}
				};

				var editor = new Editor({ settings: settings }, 'editorDiv');
				editor.startup();

				console.log("ok!");
			}
			catch(err)
			{
				console.log(err);
			}
		}
	});
	</script>
</head>
<body class="claro">
<div id="main" data-dojo-type="dijit/layout/BorderContainer" data-dojo-props="design:'headline'" style="height:width:100%;height:100%;">
	<div data-dojo-type="dijit/layout/ContentPane" id="header" data-dojo-props="region:'top'">
	Common Operational Picture
	</div>
	<div data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'left'" style="width: 200px;overflow:hidden;">
        <div id="connectivityPanel" data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'top'">
            <div id="connectivityIndicator"><i class="fa fa-link"></i></div>
        </div>
	</div>
	<div data-dojo-type="dijit/layout/ContentPane" id="map" data-dojo-props="region:'center'"></div>
	<div data-dojo-type="dijit/layout/ContentPane" data-dojo-props="region:'right'" style="width: 272px;overflow:scroll;padding:1px;">
		<div id="templateDiv"></div>
		<div id="editorDiv"></div>
	</div>
</div>
</body>
</html>