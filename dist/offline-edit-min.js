define(["dojo/Evented","dojo/_base/Deferred","dojo/DeferredList","dojo/promise/all","dojo/_base/declare","dojo/_base/array","dojo/dom-attr","dojo/dom-style","dojo/query","esri/config","esri/layers/GraphicsLayer","esri/graphic","esri/symbols/SimpleMarkerSymbol","esri/symbols/SimpleLineSymbol","esri/symbols/SimpleFillSymbol","esri/urlUtils"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){"use strict";return e("O.esri.Edit.OfflineFeaturesManager",[a],{_onlineStatus:"online",_featureLayers:{},_editStore:new O.esri.Edit.EditStore,ONLINE:"online",OFFLINE:"offline",RECONNECTING:"reconnecting",attachmentsStore:null,proxyPath:null,events:{EDITS_SENT:"edits-sent",EDITS_ENQUEUED:"edits-enqueued",ALL_EDITS_SENT:"all-edits-sent",ATTACHMENT_ENQUEUED:"attachment-enqueued",ATTACHMENTS_SENT:"attachments-sent"},initAttachments:function(a){if(a=a||function(a){},!this._checkFileAPIs())return a(!1,"File APIs not supported");try{if(this.attachmentsStore=new O.esri.Edit.AttachmentsStore,!this.attachmentsStore.isSupported())return a(!1,"indexedDB not supported");this.attachmentsStore.init(a)}catch(b){}},extend:function(a,c){function e(){try{a._phantomLayer=new k({opacity:.8}),a._map.addLayer(a._phantomLayer)}catch(b){}}var j=this;j._editStore.init(function(a){c(a)}),this._featureLayers[a.url]=a,a._applyEdits=a.applyEdits,a._addAttachment=a.addAttachment,a._queryAttachmentInfos=a.queryAttachmentInfos,a._deleteAttachments=a.deleteAttachments,a.queryAttachmentInfos=function(a,c,d){if(j.getOnlineStatus()===j.ONLINE){var e=this._queryAttachmentInfos(a,function(){j.emit(j.events.ATTACHMENTS_INFO,arguments),c&&c.apply(this,arguments)},d);return e}if(j.attachmentsStore){var f=new b;return j.attachmentsStore.getAttachmentsByFeatureId(this.url,a,function(a){c&&c(a),f.resolve(a)}),f}},a.addAttachment=function(a,c,d,e){if(j.getOnlineStatus()===j.ONLINE)return this._addAttachment(a,c,function(){j.emit(j.events.ATTACHMENTS_SENT,arguments),d&&d.apply(this,arguments)},function(a){e&&e.apply(this,arguments)});if(j.attachmentsStore){var f=this._getFilesFromForm(c),g=f[0],h=new b,k=this._getNextTempId();return j.attachmentsStore.store(this.url,k,a,g,function(b,c){var f={attachmentId:k,objectId:a,success:b};if(b){j.emit(j.events.ATTACHMENT_ENQUEUED,f),d&&d(f),h.resolve(f);var g=this._url.path+"/"+a+"/attachments/"+k,l=i("[href="+g+"]");l.attr("href",c.url)}else f.error="can't store attachment",e&&e(f),h.reject(f)}.bind(this)),h}},a.deleteAttachments=function(a,c,e,f){if(j.getOnlineStatus()===j.ONLINE){var g=this._deleteAttachments(a,c,function(){e&&e.apply(this,arguments)},function(a){f&&f.apply(this,arguments)});return g}if(j.attachmentsStore){var h=[];c.forEach(function(c){c=parseInt(c,10);var d=new b;j.attachmentsStore.delete(c,function(b){var e={objectId:a,attachmentId:c,success:b};d.resolve(e)}),h.push(d)},this);var i=d(h);return i.then(function(a){e&&e(a)}),i}},a.applyEdits=function(a,c,e,f,i){var k=[];if(j.getOnlineStatus()===j.ONLINE){var m=this._applyEdits(a,c,e,function(){j.emit(j.events.EDITS_SENT,arguments),f&&f.apply(this,arguments)},i);return m}var n=new b,o={addResults:[],updateResults:[],deleteResults:[]},p={};this.onBeforeApplyEdits(a,c,e),a=a||[],a.forEach(function(a){var c=new b,d=this._getNextTempId();a.attributes[this.objectIdField]=d,j._editStore.pushEdit(j._editStore.ADD,this.url,a,function(a,b){1==a?c.resolve(a):c.reject(b)}),o.addResults.push({success:!0,error:null,objectId:d});var e=new l(a.geometry,j._getPhantomSymbol(a.geometry,j._editStore.ADD),{objectId:d});this._phantomLayer.add(e),g.set(e.getNode(),"stroke-dasharray","10,4"),h.set(e.getNode(),"pointer-events","none"),k.push(c)},this),c=c||[],c.forEach(function(a){var c=new b,d=a.attributes[this.objectIdField];p[d]=a,j._editStore.pushEdit(j._editStore.UPDATE,this.url,a,function(a,b){1==a?c.resolve(a):c.reject(b)}),o.updateResults.push({success:!0,error:null,objectId:d});var e=new l(a.geometry,j._getPhantomSymbol(a.geometry,j._editStore.UPDATE),{objectId:d});this._phantomLayer.add(e),g.set(e.getNode(),"stroke-dasharray","5,2"),h.set(e.getNode(),"pointer-events","none"),k.push(c)},this),e=e||[],e.forEach(function(a){var c=new b,d=a.attributes[this.objectIdField];j._editStore.pushEdit(j._editStore.DELETE,this.url,a,function(a,b){1==a?c.resolve(a):c.reject(b)}),o.deleteResults.push({success:!0,error:null,objectId:d});var e=new l(a.geometry,j._getPhantomSymbol(a.geometry,j._editStore.DELETE),{objectId:d});this._phantomLayer.add(e),g.set(e.getNode(),"stroke-dasharray","4,4"),h.set(e.getNode(),"pointer-events","none"),j.attachmentsStore&&j.attachmentsStore.deleteAttachmentsByFeatureId(this.url,d,function(a){}),k.push(c)},this),d(k).then(function(){return setTimeout(function(){this._editHandler(o,a,p,f,i,n),j.emit(j.events.EDITS_ENQUEUED,o)}.bind(this),0),n}.bind(this))},a.convertGraphicLayerToJSON=function(a,b,c){var d={};d.objectIdFieldName=b.target.objectIdField,d.globalIdFieldName=b.target.globalIdField,d.geometryType=b.target.geometryType,d.spatialReference=b.target.spatialReference,d.fields=b.target.fields;for(var e=a.length,f=[],g=0;e>g;g++){var h=a[g].toJson();if(f.push(h),g==e-1){var i=JSON.stringify(f),j=JSON.stringify(d);c(i,j);break}}},a.setPhantomLayerGraphics=function(a){var b=a.length;if(b>0)for(var c=0;b>c;c++){var d=new l(a[c]);this._phantomLayer.add(d)}},a.getPhantomLayerGraphics=function(b){for(var c=a._phantomLayer.graphics,d=a._phantomLayer.graphics.length,e=[],f=0;d>f;f++){var g=c[f].toJson();if(e.push(g),f==d-1){var h=JSON.stringify(e);b(h);break}}},a.getFeatureDefinition=function(a,b,c,d){var e={layerDefinition:a,featureSet:{features:b,geometryType:c}};d(e)},a._getFilesFromForm=function(a){var b=[],c=f.filter(a.elements,function(a){return"file"===a.type});return c.forEach(function(a){b.push.apply(b,a.files)},this),b},a._replaceFeatureIds=function(a,b,c){a.length||c(0);var d,e=a.length,f=e,g=0;for(d=0;e>d;d++)j.attachmentsStore.replaceFeatureId(this.url,a[d],b[d],function(a){--f,g+=a?1:0,0===f&&c(g)}.bind(this))},a._nextTempId=-1,a._getNextTempId=function(){return this._nextTempId--},e()},goOffline:function(){this._onlineStatus=this.OFFLINE},goOnline:function(a){this._onlineStatus=this.RECONNECTING,this._replayStoredEdits(function(b,c){var d={features:{success:b,responses:c}};null!=this.attachmentsStore?this._sendStoredAttachments(function(b,c){this._onlineStatus=this.ONLINE,d.attachments={success:b,responses:c},a&&a(d)}.bind(this)):(this._onlineStatus=this.ONLINE,a&&a(d))}.bind(this))},getOnlineStatus:function(){return this._onlineStatus},_checkFileAPIs:function(){return window.File&&window.FileReader&&window.FileList&&window.Blob?(XMLHttpRequest.prototype.sendAsBinary||(XMLHttpRequest.prototype.sendAsBinary=function(a){function b(a){return 255&a.charCodeAt(0)}var c=Array.prototype.map.call(a,b),d=new Uint8Array(c);this.send(d.buffer)}),!0):!1},_extendAjaxReq:function(a){a.sendAsBinary=XMLHttpRequest.prototype.sendAsBinary},_phantomSymbols:[],_getPhantomSymbol:function(a,b){if(0===this._phantomSymbols.length){var c=[0,255,0,255],d=1.5;this._phantomSymbols.point=[],this._phantomSymbols.point[this._editStore.ADD]=new m({type:"esriSMS",style:"esriSMSCross",xoffset:10,yoffset:10,color:[255,255,255,0],size:15,outline:{color:c,width:d,type:"esriSLS",style:"esriSLSSolid"}}),this._phantomSymbols.point[this._editStore.UPDATE]=new m({type:"esriSMS",style:"esriSMSCircle",xoffset:0,yoffset:0,color:[255,255,255,0],size:15,outline:{color:c,width:d,type:"esriSLS",style:"esriSLSSolid"}}),this._phantomSymbols.point[this._editStore.DELETE]=new m({type:"esriSMS",style:"esriSMSX",xoffset:0,yoffset:0,color:[255,255,255,0],size:15,outline:{color:c,width:d,type:"esriSLS",style:"esriSLSSolid"}}),this._phantomSymbols.multipoint=null,this._phantomSymbols.polyline=[],this._phantomSymbols.polyline[this._editStore.ADD]=new n({type:"esriSLS",style:"esriSLSSolid",color:c,width:d}),this._phantomSymbols.polyline[this._editStore.UPDATE]=new n({type:"esriSLS",style:"esriSLSSolid",color:c,width:d}),this._phantomSymbols.polyline[this._editStore.DELETE]=new n({type:"esriSLS",style:"esriSLSSolid",color:c,width:d}),this._phantomSymbols.polygon=[],this._phantomSymbols.polygon[this._editStore.ADD]=new o({type:"esriSFS",style:"esriSFSSolid",color:[255,255,255,0],outline:{type:"esriSLS",style:"esriSLSSolid",color:c,width:d}}),this._phantomSymbols.polygon[this._editStore.UPDATE]=new o({type:"esriSFS",style:"esriSFSSolid",color:[255,255,255,0],outline:{type:"esriSLS",style:"esriSLSDash",color:c,width:d}}),this._phantomSymbols.polygon[this._editStore.DELETE]=new o({type:"esriSFS",style:"esriSFSSolid",color:[255,255,255,0],outline:{type:"esriSLS",style:"esriSLSDot",color:c,width:d}})}return this._phantomSymbols[a.type][b]},_fieldSegment:function(a,b){return'Content-Disposition: form-data; name="'+a+'"\r\n\r\n'+b+"\r\n"},_fileSegment:function(a,b,c,d){return'Content-Disposition: form-data; name="'+a+'"; filename="'+b+'"\r\nContent-Type: '+c+"\r\n\r\n"+d+"\r\n"},_uploadAttachment:function(a){var c=new b,d=[];d.push(this._fieldSegment("f","json")),d.push(this._fileSegment("attachment",a.name,a.contentType,a.content));var e=new XMLHttpRequest;e.sendAsBinary||this._extendAjaxReq(e),e.onload=function(a){c.resolve(JSON.parse(a.target.response))},e.onerror=function(a){c.reject(a)};var f=this.proxyPath||j.defaults.io.proxyUrl||"";""!==f&&(f+="?"),e.open("post",f+a.featureId+"/addAttachment",!0);var g="---------------------------"+Date.now().toString(16);return e.setRequestHeader("Content-Type","multipart/form-data; boundary="+g),e.sendAsBinary("--"+g+"\r\n"+d.join("--"+g+"\r\n")+"--"+g+"--\r\n"),c},_deleteAttachment:function(a,c){var d=new b;return this.attachmentsStore.delete(a,function(a){d.resolve(c)}),d},_sendStoredAttachments:function(a){this.attachmentsStore.getAllAttachments(function(b){var c=[];b.forEach(function(a){var b=this._uploadAttachment(a).then(function(b){return b.addAttachmentResult&&b.addAttachmentResult.success===!0?this._deleteAttachment(a.id,b):null}.bind(this),function(){});c.push(b)},this);var e=d(c);e.then(function(b){a&&a(!0,b)},function(b){a&&a(!1,b)})}.bind(this))},_replayStoredEdits:function(a){var b,c={},e=this,f=[],g=[],h=[],i=[],j=[],k=this._featureLayers,m=this.attachmentsStore,n=this._editStore;this._editStore.getAllEditsArray(function(o){if(null!=o){j=o;for(var p=j.length,q=0;p>q;q++){if(b=k[j[q].layer],null==m&&b.hasAttachments)throw new Error("OfflineFeaturesManager: Attachments aren't initialized.");b._attachmentsStore=m,b.__onEditsComplete=b.onEditsComplete,b.onEditsComplete=function(){},b.__onBeforeApplyEdits=b.onBeforeApplyEdits,b.onBeforeApplyEdits=function(){},f=[],g=[],h=[],i=[];var r=new l(JSON.parse(j[q].graphic));switch(j[q].operation){case n.ADD:for(var s=0;s<b.graphics.length;s++){var t=b.graphics[s];if(t.attributes[b.objectIdField]===r.attributes[b.objectIdField]){b.remove(t);break}}i.push(r.attributes[b.objectIdField]),delete r.attributes[b.objectIdField],f.push(r);break;case n.UPDATE:g.push(r);break;case n.DELETE:h.push(r)}c[q]=e._internalApplyEdits(b,i,f,g,h)}}var u=d(c);u.then(function(b){this._cleanDatabase(b),this.emit(this.events.EDITS_SENT),this.emit(this.events.ALL_EDITS_SENT),a&&a(!0,b)}.bind(e),function(b){a&&a(!1,b)}.bind(e))})},_cleanDatabase:function(a){if(0!==Object.keys(a).length)for(var b in a)a.hasOwnProperty(b)},_internalApplyEdits:function(a,c,d,e,f){var g=new b;return a._applyEdits(d,e,f,function(b,d,e){a._phantomLayer.clear(),a.onBeforeApplyEdits=a.__onBeforeApplyEdits,delete a.__onBeforeApplyEdits;var f=b.map(function(a){return a.objectId});null!=a._attachmentsStore&&a.hasAttachments&&c.length>0?a._replaceFeatureIds(c,f,function(){g.resolve({addResults:b,updateResults:d,deleteResults:e})}):g.resolve({addResults:b,updateResults:d,deleteResults:e})},function(b){a.onEditsComplete=a.__onEditsComplete,delete a.__onEditsComplete,a.onBeforeApplyEdits=a.__onBeforeApplyEdits,delete a.__onBeforeApplyEdits,g.reject(b)}),g.promise},_optimizeEditsQueue:function(){for(var a,b,c,d,e={},f=(this._editStore.pendingEditsCount(),0);this._editStore.hasPendingEdits();){if(a=this._editStore.popFirstEdit(),b=this._featureLayers[a.layer],a.layer in e||(e[a.layer]={}),c=e[a.layer],d=a.graphic.attributes[b.objectIdField],d in c)switch(a.operation){case this._editStore.ADD:throw"can't add the same feature twice!";case this._editStore.UPDATE:c[d].graphic=a.graphic;break;case this._editStore.DELETE:0>d?(delete c[d],f-=1):c[d].operation=this._editStore.DELETE}else c[d]=a,f+=1;0===Object.keys(c).length&&delete e[a.layer]}return e},getReadableEdit:function(a){var b=this._featureLayers[a.layer],c=this._editStore._deserialize(a.graphic),d=c.geometry.type,e=a.layer.substring(a.layer.lastIndexOf("/")+1);return b&&(d+=" [id="+c.attributes[b.objectIdField]+"]"),"o:"+a.operation+", l:"+e+", g:"+d}})}),"undefined"!=typeof O?O.esri.Edit={}:(O={},O.esri={Edit:{}}),O.esri.Edit.EditStore=function(){this._db=null;var a="features_store",b="features",c="featureId";this.ADD="add",this.UPDATE="update",this.DELETE="delete",this.isSupported=function(){return window.indexedDB?!0:!1},this.pushEdit=function(a,c,d,e){var f={id:c+"/"+d.attributes.objectid,operation:a,layer:c,graphic:this._serialize(d)},g=this._db.transaction([b],"readwrite");g.oncomplete=function(){e(!0)},g.onerror=function(a){e(!1,a.target.error.message)};var h=g.objectStore(b);h.put(f)},this.getAllEdits=function(a){if(null!==this._db){var c=this._db.transaction([b]).objectStore(b).openCursor();c.onsuccess=function(b){var c=b.target.result;c?(a(c.value,null),c.continue()):a(null,"end")}.bind(this),c.onerror=function(b){a(null,b)}}else a(null,"no db")},this.getAllEditsArray=function(a){var c=[];if(null!==this._db){var d=this._db.transaction([b]).objectStore(b).openCursor();d.onsuccess=function(b){var d=b.target.result;d?(c.push(d.value),d.continue()):a(c,"end")}.bind(this),d.onerror=function(b){a(null,b)}}else a(null,"no db")},this.updateExistingEdit=function(a,c,d,e){var f=this._db.transaction([b],"readwrite").objectStore(b),g=f.get(d.attributes.objectid);g.onsuccess=function(){var b=(g.result,{id:c+"/"+d.attributes.objectid,operation:a,layer:c,graphic:d.toJson()}),h=f.put(b);h.onsuccess=function(){e(!0)},h.onerror=function(a){e(!1,a)}}},this.delete=function(a,c,d){var e=this._db,f=null,g=this,h={id:a+"/"+c.attributes.objectid,operation:null,layer:a,graphic:c.toJson()};require(["dojo/Deferred"],function(a){f=new a,g.editExists(h).then(function(a){if(a.success){f.then(function(a){g.editExists(a).then(function(a){d(0==a.success?!0:!1)},function(){d(!0)})},function(a){d(a)});var c=e.transaction([b],"readwrite").objectStore(b),i=c.delete(h.id);i.onsuccess=function(){f.resolve(h)},i.onerror=function(a){f.reject({success:!1,error:a})}}},function(){d(!1)})})},this.resetEditsQueue=function(a){var c=this._db.transaction([b],"readwrite").objectStore(b).clear();c.onsuccess=function(){setTimeout(function(){a(!0)},0)},c.onerror=function(b){a(!1,b)}},this.pendingEditsCount=function(a){var c=0,d=this._db.transaction([b]).objectStore(b);d.openCursor().onsuccess=function(b){var d=b.target.result;d?(c++,d.continue()):a(c)}},this.editExists=function(a){var c=this._db,d=null;return require(["dojo/Deferred"],function(e){d=new e;var f=c.transaction([b],"readwrite").objectStore(b),g=f.get(a.id);g.onsuccess=function(){var b=g.result;b&&b.id==a.id?d.resolve({success:!0,error:null}):d.reject({success:!1,error:"Layer id is not a match."})},g.onerror=function(a){d.reject({success:!1,error:a})}}),d},this.getUsage=function(a){var c={sizeBytes:0,editCount:0},d=this._db.transaction([b]).objectStore(b).openCursor();d.onsuccess=function(b){var d=b.target.result;if(d){var e=d.value,f=JSON.stringify(e);c.sizeBytes+=f.length,c.editCount+=1,d.continue()}else a(c,null)},d.onerror=function(b){a(null,b)}},this._serialize=function(a){var b=a.toJson(),c={attributes:b.attributes,geometry:b.geometry,infoTemplate:b.infoTemplate,symbol:b.symbol};return JSON.stringify(c)},this._deserialize=function(a){var b;return require(["esri/graphic"],function(c){b=new c(JSON.parse(a))}),b},this.init=function(d){var e=indexedDB.open(a,11);d=d||function(a){}.bind(this),e.onerror=function(a){d(!1,a.target.errorCode)}.bind(this),e.onupgradeneeded=function(a){var d=a.target.result;d.objectStoreNames.contains(b)&&d.deleteObjectStore(b);var e=d.createObjectStore(b,{keyPath:"id"});e.createIndex(c,c,{unique:!1})}.bind(this),e.onsuccess=function(a){this._db=a.target.result,d(!0)}.bind(this)},this.hasPendingEdits=function(){return"DEPRECATED at v2.5!"},this._isEditDuplicated=function(){return"DEPRECATED at v2.5!"}},O.esri.Edit.AttachmentsStore=function(){this._db=null;var a="attachments_store",b="attachments";this.isSupported=function(){return window.indexedDB?!0:!1},this.store=function(a,c,d,e,f){try{this._readFile(e,function(g){var h={id:c,objectId:d,featureId:a+"/"+d,contentType:e.type,name:e.name,size:e.size,url:this._createLocalURL(e),content:g},i=this._db.transaction([b],"readwrite");i.oncomplete=function(){f(!0,h)},i.onerror=function(a){f(!1,a.target.error.message)};var j=i.objectStore(b),k=j.put(h);k.onsuccess=function(){}}.bind(this))}catch(g){f(!1,g.stack)}},this.retrieve=function(a,c){var d=this._db.transaction([b]).objectStore(b),e=d.get(a);e.onsuccess=function(a){var b=a.target.result;b?c(!0,b):c(!1,"not found")},e.onerror=function(a){c(!1,a)}},this.getAttachmentsByFeatureId=function(a,c,d){var e=a+"/"+c,f=[],g=this._db.transaction([b]).objectStore(b),h=g.index("featureId"),i=IDBKeyRange.only(e);h.openCursor(i).onsuccess=function(a){var b=a.target.result;b?(f.push(b.value),b.continue()):d(f)}},this.getAttachmentsByFeatureLayer=function(a,c){var d=[],e=this._db.transaction([b]).objectStore(b),f=e.index("featureId"),g=IDBKeyRange.bound(a+"/",a+"/A");f.openCursor(g).onsuccess=function(a){var b=a.target.result;b?(d.push(b.value),b.continue()):c(d)}},this.getAllAttachments=function(a){var c=[],d=this._db.transaction([b]).objectStore(b);d.openCursor().onsuccess=function(b){var d=b.target.result;d?(c.push(d.value),d.continue()):a(c)}},this.deleteAttachmentsByFeatureId=function(a,c,d){var e=a+"/"+c,f=this._db.transaction([b],"readwrite").objectStore(b),g=f.index("featureId"),h=IDBKeyRange.only(e),i=0;g.openCursor(h).onsuccess=function(a){var b=a.target.result;if(b){var c=b.value;this._revokeLocalURL(c),f.delete(b.primaryKey),i++,b.continue()}else setTimeout(function(){d(i)},0)}.bind(this)},this.delete=function(a,c){this.retrieve(a,function(d,e){if(!d)return void c(!1,"attachment "+a+" not found");this._revokeLocalURL(e);var f=this._db.transaction([b],"readwrite").objectStore(b).delete(a);f.onsuccess=function(){setTimeout(function(){c(!0)},0)},f.onerror=function(a){c(!1,a)}}.bind(this))},this.deleteAll=function(a){this.getAllAttachments(function(c){c.forEach(function(a){this._revokeLocalURL(a)},this);var d=this._db.transaction([b],"readwrite").objectStore(b).clear();d.onsuccess=function(){setTimeout(function(){a(!0)},0)},d.onerror=function(b){a(!1,b)}}.bind(this))},this.replaceFeatureId=function(a,c,d,e){var f=a+"/"+c,g=this._db.transaction([b],"readwrite").objectStore(b),h=g.index("featureId"),i=IDBKeyRange.only(f),j=0;h.openCursor(i).onsuccess=function(b){var c=b.target.result;if(c){var f=a+"/"+d,h=c.value;h.featureId=f,h.objectId=d,g.put(h),j++,c.continue()}else setTimeout(function(){e(j)},1)}},this.getUsage=function(a){var c={sizeBytes:0,attachmentCount:0},d=this._db.transaction([b]).objectStore(b).openCursor();d.onsuccess=function(b){var d=b.target.result;if(d){var e=d.value,f=JSON.stringify(e);c.sizeBytes+=f.length,c.attachmentCount+=1,d.continue()}else a(c,null)}.bind(this),d.onerror=function(b){a(null,b)}},this._readFile=function(a,b){var c=new FileReader;c.onload=function(a){b(a.target.result)},c.readAsBinaryString(a)},this._createLocalURL=function(a){return window.URL.createObjectURL(a)},this._revokeLocalURL=function(a){window.URL.revokeObjectURL(a.url)},this.init=function(c){var d=indexedDB.open(a,11);c=c||function(a){}.bind(this),d.onerror=function(a){c(!1,a.target.errorCode)}.bind(this),d.onupgradeneeded=function(a){var c=a.target.result;c.objectStoreNames.contains(b)&&c.deleteObjectStore(b);var d=c.createObjectStore(b,{keyPath:"id"});d.createIndex("featureId","featureId",{unique:!1})}.bind(this),d.onsuccess=function(a){this._db=a.target.result,c(!0)}.bind(this)}};